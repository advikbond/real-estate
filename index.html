<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Profiles</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header"></header>
        
        <!-- Main Content -->
        <main class="main-content">
            <h1 class="profiles-title">Your Profiles</h1>
            
            <!-- Button Grid -->
            <div class="button-grid">
                <!-- First Row -->
                <div class="button-row">
                    <div class="profile-button project-button">
                        <div class="button-content">
                            <div class="button-header">
                                <span class="button-text">Project</span>
                                <img src="Assets/Project-c.png" alt="Project Icon" class="small-icon">
                            </div>
                            <img src="Assets/Project.png" alt="Project" class="large-icon">
                        </div>
                    </div>
                    <div class="profile-button agent-button">
                        <div class="button-content">
                            <div class="button-header">
                                <span class="button-text">Agent</span>
                                <img src="Assets/Agent-c.png" alt="Agent Icon" class="small-icon">
                            </div>
                            <img src="Assets/Agent.png" alt="Agent" class="large-icon">
                        </div>
                    </div>
                </div>
                
                <!-- Second Row -->
                <div class="button-row">
                    <div class="profile-button brokerage-button">
                        <div class="button-content">
                            <div class="button-header">
                                <span class="button-text">Brokerage</span>
                                <img src="Assets/Brokerage-c.png" alt="Brokerage Icon" class="small-icon">
                            </div>
                            <img src="Assets/Brokerage.png" alt="Brokerage" class="large-icon">
                        </div>
                    </div>
                    <div class="profile-button partner-button">
                        <div class="button-content">
                            <div class="button-header">
                                <span class="button-text">Partner</span>
                                <img src="Assets/Partner-c.png" alt="Partner Icon" class="small-icon">
                            </div>
                            <img src="Assets/Partner.png" alt="Partner" class="large-icon">
                        </div>
                    </div>
                </div>
                
                <!-- Third Row -->
                <div class="button-row">
                    <div class="profile-button admin-button">
                        <div class="button-content">
                            <div class="button-header">
                                <span class="button-text">Admin</span>
                                <img src="Assets/Admin-c.png" alt="Admin Icon" class="small-icon">
                            </div>
                            <img src="Assets/Admin.png" alt="Admin" class="large-icon">
                        </div>
                    </div>

                    <div class="profile-button account-button">
                        <div class="button-content">
                            <div class="button-header">
                                <span class="button-text">Account</span>
                                <img src="Assets/Account.png" alt="Account Icon" class="small-icon">
                            </div>
                            <img src="Assets/Account.png" alt="Account" class="large-icon">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seventh Button -->
            <div class="seventh-button-container">
                <div class="seventh-button">
                    <div class="seventh-button-content">
                        <div class="seventh-button-text-container">
                            <span class="seventh-button-text">Project Manager</span>
                        </div>
                        <div class="seventh-button-icon-container">
                            <img src="Assets/Project_manager.png" alt="Project Manager" class="seventh-button-icon">
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="footer"></footer>
    </div>

    <!-- Project Screen (Hidden by default) -->
    <div id="project-screen" class="project-screen hidden">
        <div class="project-container">
            <!-- Project Header -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

            <!-- Project Main Content -->
            <main class="project-main-content">
                <!-- New Project Entry Button -->
                <div class="new-project-button">
                    <div class="new-project-content">
                        <span class="new-project-text">New Project Entry</span>
                        <img src="Assets/New_project_entry.png" alt="New Project Entry" class="new-project-icon">
                    </div>
                </div>

                <!-- Projects Heading -->
                <div id="projects-heading" style="margin-top: 20px; width: 100%; max-width: 412px;">
                    <span style="display:block; text-align: left; font-family: Monaco; font-size: 20px; color: #000;">Projects</span>
                </div>

                <!-- Projects List Container -->
                <div id="projects-list" style="margin-top: 10px; width: 100%; max-width: 412px; display: flex; flex-direction: column; gap: 12px;"></div>
            </main>
        </div>
    </div>

    <!-- New Project Entry Screen (Hidden by default) -->
    <div id="new-project-screen" class="new-project-screen hidden">
        <div class="new-project-container">
            <!-- Project Header (Same as project screen) -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

            <!-- New Project Main Content -->
            <main class="new-project-main-content">
                <!-- Project Name Label -->
                <div class="project-name-label">
                    <span class="project-name-text">Project Name</span>
                </div>

                <!-- Project Name Input -->
                <input type="text" id="project-name-input" name="project-name" class="project-name-input" placeholder="Enter Project Name">

                <!-- Next Button -->
                <button class="next-button">Next</button>

                <!-- Plot badges will render here -->
                <div id="plot-badges" style="margin-top: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;"></div>
                <div id="plot-total-row" style="margin-top: 10px; display: none; flex-direction: column; align-items: center;">
                    <span id="plot-total-text" style="font-family: Monaco; font-size: 16px; color: #333;"></span>
                    <button id="plot-done-btn" class="save-button" style="margin-top: 10px; height: 40px; font-size: 18px;">Done</button>
                </div>

               
            </main>
        </div>
    </div>

    <!-- Partners Screen (Hidden by default) -->
    <div id="partners-screen" class="partners-screen hidden">
        <div class="partners-container">
            <!-- Project Header (Same as other screens) -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

            <!-- Partners Main Content -->
            <main class="partners-main-content">
                <!-- Partners Label -->
                <div class="partners-label">
                    <span class="partners-text">Partners</span>
                </div>

                <!-- Scrollable Content -->
                <div class="scrollable-content">
                <!-- Input Boxes Container -->
                <div class="input-boxes-container">
                    <!-- Input Box 1 - Name -->
                    <div class="input-box-wrapper name-wrapper" id="nameWrapper">
                        <span class="input-number">1</span>
                        <input type="text" class="partner-input name-input" id="nameInput" name="partner-name" placeholder="Enter the name">
                        <!-- Selected Role Display (hidden by default) -->
                        <div class="selected-role-display" id="selectedRoleDisplay" style="display: none;">
                            <span class="selected-role-text" id="selectedRoleText"></span>
                            <div class="role-icon-container">
                                <img src="" alt="" class="role-icon" id="roleIcon">
                                <img src="Assets/Remove.png" alt="Remove" class="remove-role-icon" onclick="removeRole(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Horizontal Row for Other Inputs -->
                    <div class="horizontal-inputs-row">
                    <!-- Input Box 2 - Contact Number -->
                    <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="text" class="partner-input small-input" name="partner-contact" placeholder="Contact number">
                    </div>

                        <!-- Input Box 3 - Email (Optional) -->
                    <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="email" class="partner-input small-input" name="partner-email" placeholder="Email (optional)">
                    </div>

                    <!-- Input Box 4 - Select Role -->
                    <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <div class="dropdown-container small-dropdown">
                            <button class="dropdown-button" onclick="toggleDropdown(event)">
                                <span class="dropdown-text">Select Role</span>
                                <span class="dropdown-arrow">^</span>
                            </button>
                            <div class="dropdown-menu" id="dropdownMenu">
                                    <div class="options-container">
                                        <div class="dropdown-option admin-option" onclick="selectRole('Admin', 'Assets/Admin-c.png', event)">
                                            <div class="option-content">
                                                <img src="Assets/Admin-c.png" alt="Admin" class="option-icon">
                                                <span class="option-text">Admin</span>
                                            </div>
                                        </div>
                                        <div class="dropdown-option partner-option" onclick="selectRole('Partner', 'Assets/Partner-c.png', event)">
                                            <div class="option-content">
                                                <img src="Assets/Partner-c.png" alt="Partner" class="option-icon">
                                                <span class="option-text">Partner</span>
                                            </div>
                                        </div>
                                </div>
                                    <div class="skip-text-container">
                                        <span class="skip-text" onclick="selectRole('Skip', '', event)">Skip</span>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Additional Partners Container -->
                    <div class="additional-partners-container" id="additionalPartnersContainer" style="display: none;">
                        <!-- Additional partners will be added here -->
                    </div>
                </div>

                <!-- Bottom Section with Add Partners and Next Button -->
                <div class="bottom-section">
                    <!-- Add Partners Group -->
                    <div class="add-partners-group" onclick="addNewPartner()">
                        <!-- Add Partners Icon -->
                        <div class="add-partners-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 72 72" fill="none">
                            <circle cx="36" cy="36" r="36" fill="white"/>
                            <path d="M36.6093 11.52V35.7508M12.96 35.7508H36.6093M36.6093 61.1762V35.7508M36.6093 35.7508H59.04" stroke="#F28482" stroke-opacity="0.72" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>

                    <!-- Add Partners Text -->
                    <span class="add-partners-text">Add Partners</span>
                </div>

                <!-- Next Button -->
                <button class="next-button" onclick="goToBrokerage()">Next</button>
                </div>
            </main>
        </div>
    </div>

    <!-- Brokerage Screen -->
    <div class="brokerage-screen hidden" id="brokerage-screen">
        <div class="brokerage-container">
            <!-- Project Header (Same as other screens) -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon" onclick="goBackToPartners()">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

        <!-- Brokerage Main Content -->
        <main class="partners-main-content">
            <!-- Partners Label -->
            <div class="partners-label">
                <span class="partners-text">Brokerage</span>
            </div>

            <!-- Scrollable Content -->
            <div class="scrollable-content">
                <!-- Input Boxes Container -->
                <div class="input-boxes-container">
                    <!-- Input Box 1 - Brokerage Name -->
                    <div class="input-box-wrapper name-wrapper" id="brokerageNameWrapper">
                        <span class="input-number">1</span>
                        <input type="text" class="partner-input name-input" id="brokerageNameInput" name="brokerage-name" placeholder="Enter the Brokerage name">
                        <!-- Selected Brokerage Display (hidden by default) -->
                        <div class="selected-role-display" id="selectedBrokerageDisplay" style="display: none;">
                            <span class="selectedRoleText" id="selectedBrokerageText"></span>
                            <div class="role-icon-container">
                                <img src="Assets/Brokerage-c.png" alt="Brokerage" class="role-icon">
                                <img src="Assets/Remove.png" alt="Remove" class="remove-role-icon" onclick="removeBrokerage(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Horizontal Row for Other Inputs -->
                    <div class="horizontal-inputs-row">
                        <!-- Input Box 2 - Contact Number -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="text" class="partner-input small-input" name="partner-contact" placeholder="Contact number">
                        </div>

                        <!-- Input Box 3 - Phone Number (Optional) -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="email" class="partner-input small-input" name="partner-email" placeholder="Email (optional)">
                        </div>
                    </div>
                </div>

                <!-- Additional Brokerages Container -->
                <div class="additional-brokerages-container" id="additionalBrokeragesContainer" style="display: none;">
                    <!-- Additional brokerages will be added here -->
                </div>
            </div>

            <!-- Bottom Section with Add Partners and Next Button -->
            <div class="bottom-section">
                <!-- Add Partners Group -->
                <div class="add-partners-group" onclick="addNewBrokerage()">
                    <!-- Add Partners Icon -->
                    <div class="add-partners-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 72 72" fill="none">
                            <circle cx="36" cy="36" r="36" fill="white"/>
                            <path d="M36.6093 11.52V35.7508M12.96 35.7508H36.6093M36.6093 61.1762V35.7508M36.6093 35.7508H59.04" stroke="#F28482" stroke-opacity="0.72" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>

                    <!-- Add Partners Text -->
                    <span class="add-partners-text">Add Brokerage</span>
                </div>

                <!-- Next Button -->
                <button class="next-button" onclick="goToAgent()">Next</button>
            </div>
        </main>
        </div>
    </div>

    <!-- Agent Screen -->
    <div class="agent-screen hidden" id="agent-screen">
        <div class="agent-container">
            <!-- Project Header (Same as other screens) -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon" onclick="goBackToBrokerage()">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

        <!-- Agent Main Content -->
        <main class="partners-main-content">
            <!-- Partners Label -->
            <div class="partners-label">
                <span class="partners-text">Agent</span>
            </div>

            <!-- Scrollable Content -->
            <div class="scrollable-content">
                <!-- Input Boxes Container -->
                <div class="input-boxes-container">
                    <!-- Input Box 1 - Agent Name -->
                    <div class="input-box-wrapper name-wrapper" id="agentNameWrapper">
                        <span class="input-number">1</span>
                        <input type="text" class="partner-input name-input" id="agentNameInput" name="agent-name" placeholder="Enter the Agent name">
                        <!-- Selected Agent Display (hidden by default) -->
                        <div class="selected-role-display" id="selectedAgentDisplay" style="display: none;">
                            <span class="selectedRoleText" id="selectedAgentText"></span>
                            <div class="role-icon-container">
                                <img src="Assets/Agent-c.png" alt="Agent" class="role-icon">
                                <img src="Assets/Remove.png" alt="Remove" class="remove-role-icon" onclick="removeAgent(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Horizontal Row for Other Inputs -->
                    <div class="horizontal-inputs-row">
                        <!-- Input Box 2 - Contact Number -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="text" class="partner-input small-input" name="partner-contact" placeholder="Contact number">
                        </div>

                        <!-- Input Box 3 - Phone Number (Optional) -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="email" class="partner-input small-input" name="partner-email" placeholder="Email (optional)">
                        </div>
                    </div>
                </div>

                <!-- Additional Agents Container -->
                <div class="additional-agents-container" id="additionalAgentsContainer" style="display: none;">
                    <!-- Additional agents will be added here -->
                </div>
            </div>

            <!-- Bottom Section with Add Agents and Next Button -->
            <div class="bottom-section">
                <!-- Add Partners Group -->
                <div class="add-partners-group" onclick="addNewAgent()">
                    <!-- Add Partners Icon -->
                    <div class="add-partners-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 72 72" fill="none">
                            <circle cx="36" cy="36" r="36" fill="white"/>
                            <path d="M36.6093 11.52V35.7508M12.96 35.7508H36.6093M36.6093 61.1762V35.7508M36.6093 35.7508H59.04" stroke="#F28482" stroke-opacity="0.72" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>

                    <!-- Add Partners Text -->
                    <span class="add-partners-text">Add Agent</span>
                </div>

                <!-- Next Button -->
                <button class="next-button" onclick="goToPhotosVideosSelection()">Next</button>
            </div>
            </main>
        </div>
    </div>

    <!-- Photos and Videos Selection Screen -->
    <div class="photos-videos-selection-screen hidden" id="photos-videos-selection-screen">
        <div class="photos-videos-container">
            <!-- Project Header (Same as other screens) -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon" onclick="goBackToAgent()">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

            <!-- Photos and Videos Main Content -->
            <main class="photos-videos-main-content">
                <!-- Photos and Videos Header -->
                <div class="photos-videos-header">
                    <span class="photos-videos-text">Photos and Videos</span>
                </div>

                <!-- Photos Upload Container -->
                <div class="upload-selection-container">
                    <input type="file" id="photo-upload-input" name="photo-upload" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                    <div id="photos-upload-area" class="upload-area" onclick="selectUploadType('photos')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="54" height="46" viewBox="0 0 54 46" fill="none">
                            <path d="M17.4121 0.5H36.5879C36.8977 0.499727 37.2005 0.595444 37.4541 0.773438C37.7068 0.950953 37.8988 1.20187 38.0039 1.49219V1.49316L40.0293 7.16797L40.1475 7.5H49C51.4864 7.5 53.5 9.51364 53.5 12V40.5C53.5 42.9864 51.4864 45 49 45H5C2.51364 45 0.5 42.9864 0.5 40.5V12C0.500001 9.51364 2.51364 7.5 5 7.5H13.8525L13.9707 7.16895L16.002 1.49316L16.0029 1.49219C16.2129 0.8996 16.7788 0.500164 17.4121 0.5Z" stroke="#E96B68"/>
                        </svg>
                        <span class="upload-selection-text">Upload photos</span>
                    </div>
                    <div id="photos-preview-content" class="preview-content" style="display: none;">
                        <div class="preview-scroll">
                            <div id="photos-preview-list" class="preview-list"></div>
                        </div>
                        <div class="preview-footer">
                            <span class="preview-label">Photos</span>
                            <button class="add-more-btn" onclick="addMorePhotos()">+</button>
                        </div>
                    </div>
                </div>

                <!-- Videos Upload Container -->
                <div class="upload-selection-container">
                    <input type="file" id="video-upload-input" name="video-upload" accept="video/*" multiple style="display: none;" onchange="handleVideoUpload(event)">
                    <div id="videos-upload-area" class="upload-area" onclick="selectUploadType('videos')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="56" height="44" viewBox="0 0 56 44" fill="none">
                            <path d="M4 0.5H41C42.9301 0.5 44.5 2.06989 44.5 4V14.3652L45.249 13.9336L53.249 9.32715H53.25C54.2482 8.75073 55.5 9.47274 55.5 10.625V33.3809C55.5 34.5255 54.2494 35.2499 53.25 34.6729H53.249L45.249 30.0664L44.5 29.6348V40C44.5 41.9301 42.9301 43.5 41 43.5H4C2.06989 43.5 0.5 41.9301 0.5 40V4C0.5 2.06989 2.06989 0.5 4 0.5ZM51.25 14.5039L44.75 18.248L44.5 18.3926V25.6143L44.751 25.7588L51.251 29.4961L52 29.9268V14.0723L51.25 14.5039ZM9 8C8.44886 8 8 8.44886 8 9V12C8 12.5511 8.44886 13 9 13H16C16.5511 13 17 12.5511 17 12V9C17 8.44886 16.5511 8 16 8H9Z" stroke="#E96B68"/>
                        </svg>
                        <span class="upload-selection-text">Upload videos</span>
                    </div>
                    <div id="videos-preview-content" class="preview-content" style="display: none;">
                        <div class="preview-scroll">
                            <div id="videos-preview-list" class="preview-list"></div>
                        </div>
                        <div class="preview-footer">
                            <span class="preview-label">Videos</span>
                            <button class="add-more-btn" onclick="addMoreVideos()">+</button>
                        </div>
                    </div>
                </div>


                <!-- Bottom Section with Skip and Next Buttons -->
                <div class="photos-videos-bottom-section">
                    <button class="skip-selection-button" onclick="goToNextScreen()">Skip</button>
                    <button class="next-selection-button" onclick="goToUploadScreen()">Next</button>
                </div>
            </main>
        </div>
    </div>

    <!-- Upload Photos and Videos Screen -->
    <div class="upload-screen hidden" id="upload-screen">
        <div class="upload-container">
            <!-- Project Header (Same as other screens) -->
            <header class="project-header">
                <div class="project-header-content">
                    <div class="back-container">
                        <img src="Assets/Back iconn.png" alt="Back" class="back-icon" onclick="goBackToPhotosVideosSelection()">
                    </div>
                    <span class="project-text-center">Project</span>
                    <img src="Assets/Project.png" alt="Project" class="project-header-icon">
                </div>
            </header>

            <!-- Upload Main Content -->
            <main class="upload-main-content">
                <!-- Upload Header -->
                <div class="upload-header">
                    <span class="upload-text">Site layout marking</span>
                </div>

                <!-- Upload Container -->
                <div id="upload-photo-container" class="upload-photo-container" onclick="if(!window.photoUploaded) document.getElementById('main-photo-upload-input').click()">
                    <div id="upload-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <img src="Assets/Upload.png" alt="Upload" class="upload-icon" style="width: 64px; height: 64px;">
                        <span class="upload-text">Upload photo</span>
                    </div>
                    <div id="photo-preview" style="display: none; width: 100%; height: 100%; position: relative; overflow: hidden; border-radius: 15px;">
                        <div id="image-container" style="position: relative; width: 100%; height: 100%; transform-origin: 0 0;">
                            <img id="uploaded-photo" style="width: 100%; height: 100%; object-fit: contain; user-select: none; pointer-events: none;" />
                            <canvas id="plot-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; border-radius: 15px;"></canvas>
                        </div>
                    </div>
                    
                </div>

                <!-- Tool icons positioned below the expanded container -->
                <div style="display: none; margin-top: 20px; text-align: center;" id="tool-icons-container">
                    <svg id="mark-btn" class="tool-btn" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none" style="cursor: pointer; margin: 0 5px; flex-shrink: 0;">
                        <circle cx="25" cy="25" r="23.5" fill="white" stroke="#F28482" stroke-width="3"/>
                        <rect x="13" y="14" width="23" height="23" stroke="#4D00FF" stroke-width="2" stroke-dasharray="4 4"/>
                    </svg>
                    <img id="erase-btn" class="tool-btn" src="Assets/Reset.png" alt="Reset" style="width: 50px; height: 50px; object-fit: contain; cursor: pointer; margin: 0 5px; flex-shrink: 0;">
                    <svg id="undo-back-btn" class="tool-btn" xmlns="http://www.w3.org/2000/svg" width="50" height="51" viewBox="0 0 50 51" fill="none" style="cursor: pointer; margin: 0 5px; flex-shrink: 0; height: 50.633px;">
                        <circle cx="25" cy="25" r="23.5" fill="white" stroke="white" stroke-width="3"/>
                        <path d="M10.1667 15.6208C9.77571 16.0148 9.76929 16.6535 10.1524 17.0475L16.3948 23.4677C16.7779 23.8617 17.4054 23.8617 17.7963 23.4677C18.1873 23.0737 18.1937 22.435 17.8107 22.041L12.2618 16.3342L17.9253 10.6273C18.3163 10.2334 18.3227 9.59461 17.9396 9.20064C17.5565 8.80666 16.929 8.80666 16.5381 9.20063L10.1667 15.6208ZM41.0306 26.5478L42.0216 26.5262L41.0306 26.5478ZM10.8603 37.2732L10.8534 38.282L30.7006 38.2155L30.7074 37.2067L30.7143 36.1979L10.8672 36.2644L10.8603 37.2732ZM22.8553 37.233L22.8621 36.2242L10.8672 36.2644L10.8603 37.2732L10.8534 38.282L22.8484 38.2419L22.8553 37.233ZM30.8833 16.3342L30.8934 15.3253L10.8704 15.3253L10.8603 16.3342L10.8502 17.343L30.8732 17.343L30.8833 16.3342ZM41.0306 26.5478L42.0216 26.5262C41.9536 20.3019 37.0094 15.3253 30.8934 15.3253L30.8833 16.3342L30.8732 17.343C35.9109 17.343 39.9835 21.4422 40.0395 26.5693L41.0306 26.5478ZM30.7074 37.2067L30.7006 38.2155C36.9896 38.1945 42.0915 32.9266 42.0216 26.5262L41.0306 26.5478L40.0395 26.5693C40.0971 31.8413 35.8946 36.1805 30.7143 36.1979L30.7074 37.2067Z" fill="#E96B68"/>
                    </svg>
                    <img id="zoom-in-btn" src="Assets/Zoom-in.png" alt="Zoom In" style="width: 50px; height: 50px; object-fit: contain; cursor: pointer; margin: 0 5px; flex-shrink: 0;">
                    <svg id="zoom-out-btn" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none" style="cursor: pointer; margin: 0 5px; flex-shrink: 0;">
                        <circle cx="25" cy="25" r="23.5" fill="white" stroke="white" stroke-width="3"/>
                        <line x1="41.0142" y1="25" x2="7.99988" y2="25" stroke="#F28482" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>

                <!-- Site Layout Text -->
                <div class="site-layout-text">
                    <span>Photo of the site layout</span>
                </div>
                
                <input type="file" id="main-photo-upload-input" name="main-photo-upload" accept="image/*" multiple style="display: none;" onchange="handleMainPhotoUpload(event)">
                
                <!-- Bottom Section with Save Button -->
                <div class="upload-bottom-section" style="display: flex; justify-content: flex-end; align-items: center;">
                    <div>
                        <button id="save-upload-btn" class="save-button" style="display: none;" onclick="saveAndGoToNextScreen()">Next</button>
                    </div>
                </div>
            </main>
            
            
        </div>
    </div>

    <script>
        // Global variables for data storage
        let currentProjectId = null;
        let projectData = {
            name: '',
            partners: [],
            brokerages: [],
            agents: [],
            mediaFiles: []
        };

        // API utility functions
        const API_BASE_URL = 'https://real-estate-backendd.onrender.com';

        async function createProject(projectName) {
            try {
                const response = await fetch(`${API_BASE_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: projectName })
                });
                const result = await response.json();
                if (result.success) {
                    currentProjectId = result.projectId;
                    projectData.name = projectName;
                    console.log('Project created:', result);
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to create project');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Failed to create project: ' + error.message);
                throw error;
            }
        }

        async function savePartners(partners, projectName) {
            if (!currentProjectId) {
                throw new Error('No project ID available');
            }
            try {
                const response = await fetch(`${API_BASE_URL}/projects/${currentProjectId}/partners`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ partners, projectName })
                });
                const result = await response.json();
                if (result.success) {
                    projectData.partners = partners;
                    // Also save to localStorage for modal access
                    localStorage.setItem('selectedPartners', JSON.stringify(partners));
                    console.log('Partners saved:', result);
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to save partners');
                }
            } catch (error) {
                console.error('Error saving partners:', error);
                alert('Failed to save partners: ' + error.message);
                throw error;
            }
        }

        async function saveBrokerages(brokerages, projectName) {
            if (!currentProjectId) {
                throw new Error('No project ID available');
            }
            try {
                const response = await fetch(`${API_BASE_URL}/projects/${currentProjectId}/brokerages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ brokerages, projectName })
                });
                const result = await response.json();
                if (result.success) {
                    projectData.brokerages = brokerages;
                    console.log('Brokerages saved:', result);
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to save brokerages');
                }
            } catch (error) {
                console.error('Error saving brokerages:', error);
                alert('Failed to save brokerages: ' + error.message);
                throw error;
            }
        }

        async function saveAgents(agents, projectName) {
            if (!currentProjectId) {
                throw new Error('No project ID available');
            }
            try {
                const response = await fetch(`${API_BASE_URL}/projects/${currentProjectId}/agents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ agents, projectName })
                });
                const result = await response.json();
                if (result.success) {
                    projectData.agents = agents;
                    console.log('Agents saved:', result);
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to save agents');
                }
            } catch (error) {
                console.error('Error saving agents:', error);
                alert('Failed to save agents: ' + error.message);
                throw error;
            }
        }

        async function uploadMediaFiles(files) {
            if (!currentProjectId) {
                throw new Error('No project ID available');
            }
            try {
                const formData = new FormData();
                files.forEach(file => {
                    formData.append('files', file);
                });

                const response = await fetch(`${API_BASE_URL}/projects/${currentProjectId}/media`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    projectData.mediaFiles = result.files;
                    console.log('Media files uploaded:', result);
                    
                    // Update local arrays with Supabase URLs
                    result.files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            uploadedPhotos.push({
                                file: { name: file.originalName },
                                url: file.url, // Supabase Storage URL
                                name: file.originalName
                            });
                        } else if (file.type.startsWith('video/')) {
                            uploadedVideos.push({
                                file: { name: file.originalName },
                                url: file.url, // Supabase Storage URL
                                name: file.originalName
                            });
                        }
                    });
                    
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to upload media files');
                }
            } catch (error) {
                console.error('Error uploading media files:', error);
                alert('Failed to upload media files: ' + error.message);
                throw error;
            }
        }

        // Show project screen when Project button is clicked
        document.querySelector('.project-button').addEventListener('click', function() {
            document.getElementById('project-screen').classList.remove('hidden');
        });

        // Hide project screen when back button is clicked
        document.querySelector('.back-icon').addEventListener('click', function() {
            document.getElementById('project-screen').classList.add('hidden');
        });

        // Show new project screen when New Project Entry button is clicked
        document.querySelector('.new-project-button').addEventListener('click', function() {
            document.getElementById('new-project-screen').classList.remove('hidden');
        });

        // Handle project name submission
        document.querySelector('.new-project-main-content .next-button').addEventListener('click', async function() {
            const projectNameInput = document.getElementById('project-name-input');
            const projectName = projectNameInput.value.trim();
            
            if (!projectName) {
                alert('Please enter a project name');
                return;
            }
            
            try {
                await createProject(projectName);
                document.getElementById('new-project-screen').classList.add('hidden');
                document.getElementById('partners-screen').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to create project:', error);
            }
        });

        // Render plot badges under project name on load
        (function renderPlotBadgesUnderProjectName(){
            try {
                const badgeContainer = document.getElementById('plot-badges');
                if (!badgeContainer) return;
                const dataRaw = localStorage.getItem('plotMarkingData');
                if (!dataRaw) { badgeContainer.innerHTML = ''; return; }
                const parsed = JSON.parse(dataRaw);
                const plots = Array.isArray(parsed?.plots) ? parsed.plots : [];
                badgeContainer.innerHTML = '';
                plots.forEach((plot, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.width = '48px';
                    wrapper.style.height = '48px';
                    wrapper.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none">
                          <circle cx="24" cy="24" r="24" fill="white"/>
                        </svg>
                    `;
                    const label = document.createElement('span');
                    label.textContent = String(idx + 1);
                    label.style.position = 'absolute';
                    label.style.top = '50%';
                    label.style.left = '50%';
                    label.style.transform = 'translate(-50%, -50%)';
                    label.style.color = '#E96B68';
                    label.style.fontFamily = 'Monaco';
                    label.style.fontSize = '20px';
                    badgeContainer.appendChild(wrapper);
                    wrapper.appendChild(label);
                });

                const totalRow = document.getElementById('plot-total-row');
                const totalText = document.getElementById('plot-total-text');
                const doneBtn = document.getElementById('plot-done-btn');
                if (totalRow && totalText && doneBtn) {
                    if (plots.length > 0) {
                        totalRow.style.display = 'flex';
                        totalText.textContent = 'Total plots: ' + plots.length;
                        doneBtn.onclick = function(){ addProjectFromDraft(); };
                    } else {
                        totalRow.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Failed to render plot badges under project name:', e);
            }
        })();

        // Add a project from current draft and show it under Projects
        function addProjectFromDraft() {
            try {
                const nameInput = document.getElementById('project-name-input');
                const projectName = (nameInput && nameInput.value.trim()) || (localStorage.getItem('projectNameDraft') || '').trim();
                if (!projectName) {
                    alert('Please enter a project name');
                    return;
                }
                const adminInput = document.getElementById('nameInput');
                const adminName = adminInput && adminInput.value ? adminInput.value.trim() : '';
                const createdAt = new Date();
                const projectsRaw = localStorage.getItem('projects');
                const projects = projectsRaw ? JSON.parse(projectsRaw) : [];
                projects.push({
                    id: Date.now(),
                    name: projectName,
                    admin: adminName,
                    createdAt: createdAt.toISOString()
                });
                localStorage.setItem('projects', JSON.stringify(projects));

                // Clear draft so next project starts fresh (data persists until refresh otherwise)
                localStorage.removeItem('projectNameDraft');

                // Show Project screen and render
                document.getElementById('new-project-screen').classList.add('hidden');
                document.getElementById('project-screen').classList.remove('hidden');
                renderProjectsList();
            } catch(e) {
                console.error('Failed to add project:', e);
            }
        }

        function formatDateForCard(isoString) {
            try {
                const d = new Date(isoString);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            } catch(e) { return isoString; }
        }

        function renderProjectsList() {
            try {
                const list = document.getElementById('projects-list');
                if (!list) return;
                const projectsRaw = localStorage.getItem('projects');
                const projects = projectsRaw ? JSON.parse(projectsRaw) : [];
                list.innerHTML = '';
                projects.forEach((p, idx) => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.alignItems = 'center';
                    row.style.gap = '8px';

                    const num = document.createElement('div');
                    num.textContent = String(idx + 1);
                    num.style.color = '#F28482';
                    num.style.fontFamily = 'Montserrat';
                    num.style.fontSize = '20px';
                    num.style.fontStyle = 'normal';
                    num.style.fontWeight = '700';
                    num.style.lineHeight = '20px';

                    const card = document.createElement('div');
                    card.style.width = '319px';
                    card.style.height = '90px';
                    card.style.flexShrink = '0';
                    card.style.borderRadius = '15px';
                    card.style.border = '2px solid rgba(242, 132, 130, 0.72)';
                    card.style.background = 'rgba(242, 132, 130, 0.72)';
                    card.style.boxShadow = '-4px -4px 4px 0 rgba(0, 0, 0, 0.25)';
                    card.style.padding = '10px 12px';
                    card.style.display = 'flex';
                    card.style.flexDirection = 'column';
                    card.style.justifyContent = 'space-between';

                    const title = document.createElement('div');
                    title.textContent = p.name;
                    title.style.color = '#FFF';
                    title.style.fontFamily = 'Monaco';
                    title.style.fontSize = '16px';
                    title.style.fontStyle = 'normal';
                    title.style.fontWeight = '400';
                    title.style.lineHeight = 'normal';

                    const admin = document.createElement('div');
                    admin.textContent = p.admin ? p.admin : '';
                    admin.style.color = '#000';
                    admin.style.fontFamily = 'Monaco';
                    admin.style.fontSize = '14px';
                    admin.style.fontStyle = 'normal';
                    admin.style.fontWeight = '400';
                    admin.style.lineHeight = 'normal';

                    const date = document.createElement('div');
                    date.textContent = formatDateForCard(p.createdAt);
                    date.style.color = '#BE0300';
                    date.style.fontFamily = 'Monaco';
                    date.style.fontSize = '14px';
                    date.style.fontStyle = 'normal';
                    date.style.fontWeight = '400';
                    date.style.lineHeight = 'normal';

                    card.appendChild(title);
                    card.appendChild(admin);
                    card.appendChild(date);
                    row.appendChild(num);
                    row.appendChild(card);
                    list.appendChild(row);
                });
            } catch(e) {
                console.error('Failed to render projects list:', e);
            }
        }

        // Render projects list on load in case there are existing entries
        renderProjectsList();

        // Persist project name until refresh
        (function persistProjectName(){
            try {
                const input = document.getElementById('project-name-input');
                if (!input) return;
                const saved = localStorage.getItem('projectNameDraft') || '';
                if (saved && !input.value) {
                    input.value = saved;
                }
                input.addEventListener('input', function(){
                    localStorage.setItem('projectNameDraft', input.value);
                });
            } catch(e) { /* noop */ }
        })();

        // Clear all relevant data on full page refresh (landing page)
        (function clearOnRefresh(){
            try {
                var navEntries = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation') : [];
                var navType = navEntries && navEntries[0] ? navEntries[0].type : (performance && performance.navigation ? (performance.navigation.type === 1 ? 'reload' : '') : '');
                if (navType === 'reload') {
                    localStorage.removeItem('siteDataByPlot');
                    localStorage.removeItem('plotMarkingData');
                    localStorage.removeItem('uploadedImageData');
                    localStorage.removeItem('imageTooLarge');
                    localStorage.removeItem('projectNameDraft');
                }
            } catch(e) { /* noop */ }
        })();

        // Hide new project screen when back button is clicked (from new project screen)
        document.querySelectorAll('.back-icon')[1].addEventListener('click', function() {
            document.getElementById('new-project-screen').classList.add('hidden');
        });


        // Hide partners screen when back button is clicked (from partners screen)
        document.querySelectorAll('.back-icon')[2].addEventListener('click', function() {
            document.getElementById('partners-screen').classList.add('hidden');
        });


        // Dropdown functionality
        function toggleDropdown(event) {
            // Close all other dropdowns first
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            const allArrows = document.querySelectorAll('.dropdown-arrow');
            
            allDropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            allArrows.forEach(arrow => {
                arrow.classList.remove('rotated');
            });
            
            // Open the clicked dropdown
            const button = event.target.closest('.dropdown-button');
            const dropdown = button.nextElementSibling;
            const arrow = button.querySelector('.dropdown-arrow');
            
            dropdown.classList.toggle('show');
            arrow.classList.toggle('rotated');
            
            // Auto-scroll to ensure dropdown and all input fields are visible
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    const scrollableContent = document.querySelector('.scrollable-content');
                    const dropdownRect = dropdown.getBoundingClientRect();
                    const scrollableRect = scrollableContent.getBoundingClientRect();
                    
                    // Check if dropdown is below visible area
                    if (dropdownRect.bottom > scrollableRect.bottom) {
                        const scrollAmount = dropdownRect.bottom - scrollableRect.bottom + 50; // Extra padding
                        scrollableContent.scrollTop += scrollAmount;
                    }
                    
                    // Also check if the partner's input fields are fully visible
                    const partnerSet = button.closest('.partner-input-set') || button.closest('.input-boxes-container');
                    const partnerRect = partnerSet.getBoundingClientRect();
                    
                    if (partnerRect.bottom > scrollableRect.bottom) {
                        const partnerScrollAmount = partnerRect.bottom - scrollableRect.bottom + 50;
                        scrollableContent.scrollTop += partnerScrollAmount;
                    }
                }, 100);
            }
        }

        // Role selection functionality
        function selectRole(role, iconPath, event) {
            // Find the closest partner input set
            let partnerSet = event.target.closest('.partner-input-set');
            if (!partnerSet) {
                // For first partner, use the input-boxes-container
                partnerSet = event.target.closest('.input-boxes-container');
            }
            
            const nameInput = partnerSet.querySelector('.name-input');
            const nameWrapper = partnerSet.querySelector('.name-wrapper');
            const selectedRoleDisplay = partnerSet.querySelector('.selected-role-display');
            const selectedRoleText = partnerSet.querySelector('.selectedRoleText') || partnerSet.querySelector('#selectedRoleText');
            const roleIcon = partnerSet.querySelector('.role-icon');
            const dropdown = partnerSet.querySelector('.dropdown-menu');
            const arrow = partnerSet.querySelector('.dropdown-arrow');
            const horizontalInputsRow = partnerSet.querySelector('.horizontal-inputs-row');
            
            // Get the name from input
            const name = nameInput.value.trim();
            
            if (name === '') {
                alert('Please enter a name first');
                return;
            }
            
            // Hide dropdown
            dropdown.classList.remove('show');
            arrow.classList.remove('rotated');
            
            // Hide other input fields
            horizontalInputsRow.style.display = 'none';
            
            if (role === 'Skip') {
                // For Skip, show the name with normal styling and Skip + Remove icons
                nameWrapper.className = 'input-box-wrapper name-wrapper normal-role';
                selectedRoleText.textContent = role; // Show the role, not the name
                roleIcon.src = 'Assets/Skip.png';
                roleIcon.alt = 'Skip';
                selectedRoleDisplay.style.display = 'flex';
                nameInput.style.display = 'none';
            } else {
                // For Admin or Partner, show the role display
                nameWrapper.className = `input-box-wrapper name-wrapper ${role.toLowerCase()}-role`;
                selectedRoleText.textContent = role; // Show the role, not the name
                roleIcon.src = iconPath;
                roleIcon.alt = role;
                selectedRoleDisplay.style.display = 'flex';
                nameInput.style.display = 'none';
            }
        }
        
        // Remove role functionality
        function removeRole(event) {
            // Find the closest partner input set
            let partnerSet = event.target.closest('.partner-input-set');
            if (!partnerSet) {
                // For first partner, use the input-boxes-container
                partnerSet = event.target.closest('.input-boxes-container');
            }
            
            const nameInput = partnerSet.querySelector('.name-input');
            const nameWrapper = partnerSet.querySelector('.name-wrapper');
            const selectedRoleDisplay = partnerSet.querySelector('.selected-role-display');
            const horizontalInputsRow = partnerSet.querySelector('.horizontal-inputs-row');
            
            // Reset to normal state
            nameWrapper.className = 'input-box-wrapper name-wrapper';
            selectedRoleDisplay.style.display = 'none';
            nameInput.style.display = 'block';
            nameInput.value = '';
            
            // Show other input fields again
            horizontalInputsRow.style.display = 'flex';
        }
        
        // Add new partner functionality
        function addNewPartner() {
            const additionalPartnersContainer = document.getElementById('additionalPartnersContainer');
            const partnerCount = additionalPartnersContainer.children.length + 2; // +2 because we have partner 1 and this will be partner 2+
            
            // Create new partner input set
            const newPartnerHTML = `
                <div class="partner-input-set">
                    <!-- Input Box - Name -->
                    <div class="input-box-wrapper name-wrapper">
                        <span class="input-number">${partnerCount}</span>
                        <input type="text" class="partner-input name-input" placeholder="Enter the name">
                        <!-- Selected Role Display (hidden by default) -->
                        <div class="selected-role-display" style="display: none;">
                            <span class="selectedRoleText"></span>
                            <div class="role-icon-container">
                                <img src="" alt="" class="role-icon">
                                <img src="Assets/Remove.png" alt="Remove" class="remove-role-icon" onclick="removeRole(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Horizontal Row for Other Inputs -->
                    <div class="horizontal-inputs-row">
                        <!-- Input Box - Contact Number -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="text" class="partner-input small-input" name="partner-contact" placeholder="Contact number">
                        </div>

                        <!-- Input Box - Phone Number (Optional) -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="email" class="partner-input small-input" name="partner-email" placeholder="Email (optional)">
                        </div>

                        <!-- Input Box - Select Role -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <div class="dropdown-container small-dropdown">
                                <button class="dropdown-button" onclick="toggleDropdown(event)">
                                    <span class="dropdown-text">Select Role</span>
                                    <span class="dropdown-arrow">^</span>
                                </button>
                                <div class="dropdown-menu" id="dropdownMenu">
                                    <div class="options-container">
                                        <div class="dropdown-option admin-option" onclick="selectRole('Admin', 'Assets/Admin-c.png', event)">
                                            <div class="option-content">
                                                <img src="Assets/Admin-c.png" alt="Admin" class="option-icon">
                                                <span class="option-text">Admin</span>
                                            </div>
                                        </div>
                                        <div class="dropdown-option partner-option" onclick="selectRole('Partner', 'Assets/Partner-c.png', event)">
                                            <div class="option-content">
                                                <img src="Assets/Partner-c.png" alt="Partner" class="option-icon">
                                                <span class="option-text">Partner</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="skip-text-container">
                                        <span class="skip-text" onclick="selectRole('Skip', '', event)">Skip</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add the new partner HTML to the container
            additionalPartnersContainer.insertAdjacentHTML('beforeend', newPartnerHTML);
            
            // Show the additional partners container
            additionalPartnersContainer.style.display = 'block';
            
            // Auto-scroll to show the new partner's input fields
            setTimeout(() => {
                const scrollableContent = document.querySelector('.scrollable-content');
                const newPartnerSet = additionalPartnersContainer.lastElementChild;
                const newPartnerRect = newPartnerSet.getBoundingClientRect();
                const scrollableRect = scrollableContent.getBoundingClientRect();
                
                // Calculate how much to scroll to show all input fields
                const scrollAmount = newPartnerRect.bottom - scrollableRect.bottom + 50; // Extra 50px for padding
                
                if (scrollAmount > 0) {
                    scrollableContent.scrollTop += scrollAmount;
                }
            }, 100);
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-button') && !event.target.closest('.dropdown-container')) {
                const dropdown = document.getElementById('dropdownMenu');
                const arrow = document.querySelector('.dropdown-arrow');
                dropdown.classList.remove('show');
                arrow.classList.remove('rotated');
            }
        }

        // ===== BROKERAGE SCREEN FUNCTIONS =====

        // Navigate to Brokerage screen from Partners
        async function goToBrokerage() {
            console.log('goToBrokerage function called!'); // Debug log
            
            const selectedPartners = [];
            const projectName = document.getElementById('project-name-input')?.value || '';
            
            // Get partner data from form inputs
            const nameInput = document.getElementById('nameInput');
            const selectedRoleText = document.getElementById('selectedRoleText');
            const horizontalInputsRow = document.querySelector('#nameWrapper').nextElementSibling;
            const contactInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Contact number"]') : null;
            const emailInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Email (optional)"]') : null;
            
            if (nameInput && nameInput.value.trim() && selectedRoleText && selectedRoleText.textContent) {
                selectedPartners.push({
                    name: nameInput.value.trim(),
                    type: selectedRoleText.textContent,
                    contact_number: contactInput ? contactInput.value.trim() : '',
                    email: emailInput ? emailInput.value.trim() : ''
                });
            }
            
            // Check for additional partners in the additional partners container
            const additionalPartners = document.querySelectorAll('.additional-partner-item');
            additionalPartners.forEach(partner => {
                const name = partner.querySelector('.partner-name')?.textContent;
                const type = partner.querySelector('.partner-type')?.textContent;
                const contact = partner.querySelector('.partner-contact')?.textContent || '';
                const email = partner.querySelector('.partner-email')?.textContent || '';
                if (name && type) {
                    selectedPartners.push({ name, type, contact_number: contact, email });
                }
            });
            
            console.log('Collected partners:', selectedPartners);
            
            try {
                await savePartners(selectedPartners, projectName);
            document.getElementById('partners-screen').classList.add('hidden');
            document.getElementById('brokerage-screen').classList.remove('hidden');
            console.log('Navigation completed!'); // Debug log
            } catch (error) {
                console.error('Failed to save partners:', error);
            }
        }

        // Go back to Partners screen
        function goBackToPartners() {
            document.getElementById('brokerage-screen').classList.add('hidden');
            document.getElementById('partners-screen').classList.remove('hidden');
        }

        // Navigate to Agent screen from Brokerage
        async function goToAgent() {
            const selectedBrokerages = [];
            const projectName = document.getElementById('project-name-input')?.value || '';
            
            // Get brokerage data from form inputs
            const brokerageNameInput = document.getElementById('brokerageNameInput');
            const horizontalInputsRow = document.querySelector('#brokerageNameWrapper').nextElementSibling;
            const contactInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Contact number"]') : null;
            const emailInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Email (optional)"]') : null;
            
            if (brokerageNameInput && brokerageNameInput.value.trim()) {
                selectedBrokerages.push({
                    name: brokerageNameInput.value.trim(),
                    contact_number: contactInput ? contactInput.value.trim() : '',
                    email: emailInput ? emailInput.value.trim() : ''
                });
            }
            
            // Check for additional brokerages in the additional brokerages container
            const additionalBrokerages = document.querySelectorAll('.additional-brokerage-item');
            additionalBrokerages.forEach(brokerage => {
                const name = brokerage.querySelector('.brokerage-name')?.textContent;
                const contact = brokerage.querySelector('.brokerage-contact')?.textContent || '';
                const email = brokerage.querySelector('.brokerage-email')?.textContent || '';
                if (name) {
                    selectedBrokerages.push({ name, contact_number: contact, email });
                }
            });
            
            console.log('Collected brokerages:', selectedBrokerages);
            
            try {
                await saveBrokerages(selectedBrokerages, projectName);
            document.getElementById('brokerage-screen').classList.add('hidden');
            document.getElementById('agent-screen').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to save brokerages:', error);
            }
        }

        // Go back to Brokerage screen
        function goBackToBrokerage() {
            document.getElementById('agent-screen').classList.add('hidden');
            document.getElementById('brokerage-screen').classList.remove('hidden');
        }

        // Add new brokerage functionality
        function addNewBrokerage() {
            console.log('addNewBrokerage called');
            // First, transform the current brokerage if it has all details filled
            transformCurrentBrokerage();
            
            const additionalBrokeragesContainer = document.getElementById('additionalBrokeragesContainer');
            const brokerageCount = additionalBrokeragesContainer.children.length + 2; // +2 because we have brokerage 1 and this will be brokerage 2+
            
            // Show the container if it's hidden
            additionalBrokeragesContainer.style.display = 'block';
            
            // Create new brokerage input set
            const newBrokerageHTML = `
                <div class="partner-input-set">
                    <!-- Input Box - Brokerage Name -->
                    <div class="input-box-wrapper name-wrapper">
                        <span class="input-number">${brokerageCount}</span>
                        <input type="text" class="partner-input name-input" placeholder="Enter the Brokerage name">
                        <!-- Selected Role Display (hidden by default) -->
                        <div class="selected-role-display" style="display: none;">
                            <span class="selectedRoleText"></span>
                            <div class="role-icon-container">
                                <img src="Assets/Brokerage-c.png" alt="Brokerage" class="role-icon">
                                <img src="Assets/Remove.png" alt="Remove" class="remove-role-icon" onclick="removeBrokerage(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Horizontal Row for Other Inputs -->
                    <div class="horizontal-inputs-row">
                        <!-- Input Box - Contact Number -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="text" class="partner-input small-input" name="partner-contact" placeholder="Contact number">
                        </div>

                        <!-- Input Box - Phone Number (Optional) -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="email" class="partner-input small-input" name="partner-email" placeholder="Email (optional)">
                        </div>
                    </div>
                </div>
            `;
            
            // Add the new HTML to the container
            additionalBrokeragesContainer.insertAdjacentHTML('beforeend', newBrokerageHTML);
            
            // Auto-scroll to show the new input fields
            setTimeout(() => {
                const scrollableContent = document.querySelector('.partners-main-content .scrollable-content');
                if (scrollableContent) {
                    console.log('Scrolling to show new brokerage fields');
                    
                    // Get the new brokerage element
                    const newBrokerageSet = additionalBrokeragesContainer.lastElementChild;
                    if (newBrokerageSet) {
                        // Scroll the new brokerage into view
                        newBrokerageSet.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                        
                        // Additional scroll to ensure all three fields are visible
                        setTimeout(() => {
                            const newBrokerageRect = newBrokerageSet.getBoundingClientRect();
                            const scrollableRect = scrollableContent.getBoundingClientRect();
                            
                            // If the bottom of the new brokerage is not visible, scroll more
                            if (newBrokerageRect.bottom > scrollableRect.bottom) {
                                const scrollAmount = newBrokerageRect.bottom - scrollableRect.bottom + 100;
                                console.log('Additional scroll needed:', scrollAmount);
                                scrollableContent.scrollTop += scrollAmount;
                            }
                            
                            console.log('Scroll completed - all fields should be visible');
                        }, 200);
                    }
                } else {
                    console.log('Scrollable content not found');
                }
            }, 100);
        }

        // Remove brokerage functionality
        function removeBrokerage(event) {
            event.stopPropagation();
            const brokerageSet = event.target.closest('.partner-input-set') || event.target.closest('.input-box-wrapper');
            
            if (brokerageSet) {
                // If it's the first brokerage (not in additional container), reset the form
                if (brokerageSet.id === 'brokerageNameWrapper' || brokerageSet.closest('#brokerageNameWrapper')) {
                    resetFirstBrokerage();
                } else {
                    // Remove the additional brokerage
                    brokerageSet.remove();
                    
                    // Hide additional brokerages container if empty
                    const additionalContainer = document.getElementById('additionalBrokeragesContainer');
                    if (additionalContainer && additionalContainer.children.length === 0) {
                        additionalContainer.style.display = 'none';
                    }
                }
            }
        }

        // Reset first brokerage form
        function resetFirstBrokerage() {
            const nameWrapper = document.getElementById('brokerageNameWrapper');
            const nameInput = document.getElementById('brokerageNameInput');
            const selectedBrokerageDisplay = document.getElementById('selectedBrokerageDisplay');
            const horizontalInputsRow = nameWrapper.nextElementSibling;
            
            // Reset wrapper class
            nameWrapper.className = 'input-box-wrapper name-wrapper';
            
            // Show input field and hide role display
            nameInput.style.display = 'block';
            selectedBrokerageDisplay.style.display = 'none';
            
            // Clear input values
            nameInput.value = '';
            const smallInputs = horizontalInputsRow.querySelectorAll('.partner-input');
            smallInputs.forEach(input => input.value = '');
            
            // Show horizontal inputs
            horizontalInputsRow.style.display = 'flex';
        }

        // Handle brokerage form submission (when all fields are filled)
        function handleBrokerageSubmission() {
            const nameInput = document.getElementById('brokerageNameInput');
            const name = nameInput.value.trim();
            
            if (name) {
                // Show the brokerage display
                const nameWrapper = document.getElementById('brokerageNameWrapper');
                const selectedBrokerageDisplay = document.getElementById('selectedBrokerageDisplay');
                const selectedBrokerageText = document.getElementById('selectedBrokerageText');
                const horizontalInputsRow = nameWrapper.nextElementSibling;
                
                // Apply brokerage role styling (purple theme)
                nameWrapper.className = 'input-box-wrapper name-wrapper brokerage-role';
                selectedBrokerageText.textContent = name;
                selectedBrokerageDisplay.style.display = 'flex';
                nameInput.style.display = 'none';
                
                // Hide horizontal inputs
                horizontalInputsRow.style.display = 'none';
            }
        }

        // Transform current brokerage if all details are filled
        function transformCurrentBrokerage() {
            console.log('transformCurrentBrokerage called');
            
            // Check if we're dealing with the first brokerage or an additional one
            const additionalBrokeragesContainer = document.getElementById('additionalBrokeragesContainer');
            const isFirstBrokerage = additionalBrokeragesContainer.children.length === 0;
            
            console.log('Is first brokerage:', isFirstBrokerage);
            
            if (isFirstBrokerage) {
                // Transform first brokerage
                const nameInput = document.getElementById('brokerageNameInput');
                const name = nameInput ? nameInput.value.trim() : '';
                const horizontalInputsRow = document.querySelector('#brokerageNameWrapper').nextElementSibling;
                console.log('Horizontal inputs row:', horizontalInputsRow);
                const contactInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Contact number"]') : null;
                const emailInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Email (optional)"]') : null;
                console.log('Contact input element:', contactInput);
                console.log('Email input element:', emailInput);
                const contact = contactInput ? contactInput.value.trim() : '';
                const email = emailInput ? emailInput.value.trim() : '';
                
                console.log('First brokerage details:', { name, contact, email });
                
                // Check if all details are filled (email is optional)
                if (name && contact) {
                    console.log('Transforming first brokerage');
                    const nameWrapper = document.getElementById('brokerageNameWrapper');
                    const selectedBrokerageDisplay = document.getElementById('selectedBrokerageDisplay');
                    const selectedBrokerageText = document.getElementById('selectedBrokerageText');
                    const horizontalInputsRow = nameWrapper.nextElementSibling;
                    
                    // Apply brokerage role styling (purple theme)
                    nameWrapper.className = 'input-box-wrapper name-wrapper brokerage-role';
                    selectedBrokerageText.textContent = name;
                    selectedBrokerageDisplay.style.display = 'flex';
                    nameInput.style.display = 'none';
                    
                    // Hide horizontal inputs
                    horizontalInputsRow.style.display = 'none';
                } else {
                    console.log('First brokerage details not complete');
                }
            } else {
                // Transform the last additional brokerage
                const lastBrokerageSet = additionalBrokeragesContainer.lastElementChild;
                const nameInput = lastBrokerageSet.querySelector('.name-input');
                const contactInput = lastBrokerageSet.querySelector('.partner-input[placeholder="Contact number"]');
                const emailInput = lastBrokerageSet.querySelector('.partner-input[placeholder="Email (optional)"]');
                
                const name = nameInput ? nameInput.value.trim() : '';
                const contact = contactInput ? contactInput.value.trim() : '';
                const email = emailInput ? emailInput.value.trim() : '';
                
                console.log('Additional brokerage details:', { name, contact, phone });
                
                // Check if all details are filled (email is optional)
                if (name && contact) {
                    console.log('Transforming additional brokerage');
                    const nameWrapper = nameInput.closest('.input-box-wrapper');
                    const selectedRoleDisplay = nameWrapper.querySelector('.selected-role-display');
                    const selectedRoleText = nameWrapper.querySelector('.selectedRoleText');
                    const horizontalInputsRow = nameWrapper.nextElementSibling;
                    
                    // Apply brokerage role styling (purple theme)
                    nameWrapper.className = 'input-box-wrapper name-wrapper brokerage-role';
                    selectedRoleText.textContent = 'Brokerage'; // Show the role, not the name
                    selectedRoleDisplay.style.display = 'flex';
                    nameInput.style.display = 'none';
                    
                    // Hide horizontal inputs
                    horizontalInputsRow.style.display = 'none';
                } else {
                    console.log('Additional brokerage details not complete');
                }
            }
        }

        // ===== AGENT SCREEN FUNCTIONS =====

        // Add new agent functionality
        function addNewAgent() {
            console.log('addNewAgent called');
            // First, transform the current agent if it has all details filled
            transformCurrentAgent();
            
            const additionalAgentsContainer = document.getElementById('additionalAgentsContainer');
            const agentCount = additionalAgentsContainer.children.length + 2; // +2 because we have agent 1 and this will be agent 2+
            
            // Show the container if it's hidden
            additionalAgentsContainer.style.display = 'block';
            
            // Create new agent input set
            const newAgentHTML = `
                <div class="partner-input-set">
                    <!-- Input Box - Agent Name -->
                    <div class="input-box-wrapper name-wrapper">
                        <span class="input-number">${agentCount}</span>
                        <input type="text" class="partner-input name-input" placeholder="Enter the Agent name">
                        <!-- Selected Role Display (hidden by default) -->
                        <div class="selected-role-display" style="display: none;">
                            <span class="selectedRoleText"></span>
                            <div class="role-icon-container">
                                <img src="Assets/Agent-c.png" alt="Agent" class="role-icon">
                                <img src="Assets/Remove.png" alt="Remove" class="remove-role-icon" onclick="removeAgent(event)">
                            </div>
                        </div>
                    </div>

                    <!-- Horizontal Row for Other Inputs -->
                    <div class="horizontal-inputs-row">
                        <!-- Input Box - Contact Number -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="text" class="partner-input small-input" name="partner-contact" placeholder="Contact number">
                        </div>

                        <!-- Input Box - Phone Number (Optional) -->
                        <div class="input-box-wrapper">
                            <span class="input-number invisible">1</span>
                            <input type="email" class="partner-input small-input" name="partner-email" placeholder="Email (optional)">
                        </div>
                    </div>
                </div>
            `;
            
            // Add the new HTML to the container
            additionalAgentsContainer.insertAdjacentHTML('beforeend', newAgentHTML);
            
            // Auto-scroll to show the new input fields
            setTimeout(() => {
                const scrollableContent = document.querySelector('.partners-main-content .scrollable-content');
                if (scrollableContent) {
                    console.log('Scrolling to show new agent fields');
                    
                    // Get the new agent element
                    const newAgentSet = additionalAgentsContainer.lastElementChild;
                    if (newAgentSet) {
                        // Scroll the new agent into view
                        newAgentSet.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                        
                        // Additional scroll to ensure all three fields are visible
                        setTimeout(() => {
                            const newAgentRect = newAgentSet.getBoundingClientRect();
                            const scrollableRect = scrollableContent.getBoundingClientRect();
                            
                            // If the bottom of the new agent is not visible, scroll more
                            if (newAgentRect.bottom > scrollableRect.bottom) {
                                const scrollAmount = newAgentRect.bottom - scrollableRect.bottom + 100;
                                console.log('Additional scroll needed:', scrollAmount);
                                scrollableContent.scrollTop += scrollAmount;
                            }
                            
                            console.log('Scroll completed - all fields should be visible');
                        }, 200);
                    }
                } else {
                    console.log('Scrollable content not found');
                }
            }, 100);
        }

        // Remove agent functionality
        function removeAgent(event) {
            event.stopPropagation();
            const agentSet = event.target.closest('.partner-input-set') || event.target.closest('.input-box-wrapper');
            
            if (agentSet) {
                // If it's the first agent (not in additional container), reset the form
                if (agentSet.id === 'agentNameWrapper' || agentSet.closest('#agentNameWrapper')) {
                    resetFirstAgent();
                } else {
                    // Remove the additional agent
                    agentSet.remove();
                    
                    // Hide additional agents container if empty
                    const additionalContainer = document.getElementById('additionalAgentsContainer');
                    if (additionalContainer && additionalContainer.children.length === 0) {
                        additionalContainer.style.display = 'none';
                    }
                }
            }
        }

        // Reset first agent form
        function resetFirstAgent() {
            const nameWrapper = document.getElementById('agentNameWrapper');
            const nameInput = document.getElementById('agentNameInput');
            const selectedAgentDisplay = document.getElementById('selectedAgentDisplay');
            const horizontalInputsRow = nameWrapper.nextElementSibling;
            
            // Reset wrapper class
            nameWrapper.className = 'input-box-wrapper name-wrapper';
            
            // Show input field and hide role display
            nameInput.style.display = 'block';
            selectedAgentDisplay.style.display = 'none';
            
            // Clear input values
            nameInput.value = '';
            const smallInputs = horizontalInputsRow.querySelectorAll('.partner-input');
            smallInputs.forEach(input => input.value = '');
            
            // Show horizontal inputs
            horizontalInputsRow.style.display = 'flex';
        }

        // Transform current agent if all details are filled
        function transformCurrentAgent() {
            console.log('transformCurrentAgent called');
            
            // Check if we're dealing with the first agent or an additional one
            const additionalAgentsContainer = document.getElementById('additionalAgentsContainer');
            const isFirstAgent = additionalAgentsContainer.children.length === 0;
            
            console.log('Is first agent:', isFirstAgent);
            
            if (isFirstAgent) {
                // Transform first agent
                const nameInput = document.getElementById('agentNameInput');
                const name = nameInput ? nameInput.value.trim() : '';
                const horizontalInputsRow = document.querySelector('#agentNameWrapper').nextElementSibling;
                const contactInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Contact number"]') : null;
                const emailInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Email (optional)"]') : null;
                const contact = contactInput ? contactInput.value.trim() : '';
                const email = emailInput ? emailInput.value.trim() : '';
                
                console.log('First agent details:', { name, contact, email });
                
                // Check if all details are filled (email is optional)
                if (name && contact) {
                    console.log('Transforming first agent');
                    const nameWrapper = document.getElementById('agentNameWrapper');
                    const selectedAgentDisplay = document.getElementById('selectedAgentDisplay');
                    const selectedAgentText = document.getElementById('selectedAgentText');
                    const horizontalInputsRow = nameWrapper.nextElementSibling;
                    
                    // Apply agent role styling (green theme)
                    nameWrapper.className = 'input-box-wrapper name-wrapper agent-role';
                    selectedAgentText.textContent = name;
                    selectedAgentDisplay.style.display = 'flex';
                    nameInput.style.display = 'none';
                    
                    // Hide horizontal inputs
                    horizontalInputsRow.style.display = 'none';
                } else {
                    console.log('First agent details not complete');
                }
            } else {
                // Transform the last additional agent
                const lastAgentSet = additionalAgentsContainer.lastElementChild;
                const nameInput = lastAgentSet.querySelector('.name-input');
                const contactInput = lastAgentSet.querySelector('.partner-input[placeholder="Contact number"]');
                const emailInput = lastAgentSet.querySelector('.partner-input[placeholder="Email (optional)"]');
                
                const name = nameInput ? nameInput.value.trim() : '';
                const contact = contactInput ? contactInput.value.trim() : '';
                const email = emailInput ? emailInput.value.trim() : '';
                
                console.log('Additional agent details:', { name, contact, phone });
                
                // Check if all details are filled (email is optional)
                if (name && contact) {
                    console.log('Transforming additional agent');
                    const nameWrapper = nameInput.closest('.input-box-wrapper');
                    const selectedRoleDisplay = nameWrapper.querySelector('.selected-role-display');
                    const selectedRoleText = nameWrapper.querySelector('.selectedRoleText');
                    const horizontalInputsRow = nameWrapper.nextElementSibling;
                    
                    // Apply agent role styling (green theme)
                    nameWrapper.className = 'input-box-wrapper name-wrapper agent-role';
                    selectedRoleText.textContent = 'Agent'; // Show the role, not the name
                    selectedRoleDisplay.style.display = 'flex';
                    nameInput.style.display = 'none';
                    
                    // Hide horizontal inputs
                    horizontalInputsRow.style.display = 'none';
                } else {
                    console.log('Additional agent details not complete');
                }
            }
        }

        // Event listeners for Brokerage screen
        document.addEventListener('DOMContentLoaded', function() {
            // No automatic transformation - only on + button click
        });

        // ===== PHOTOS VIDEOS SELECTION SCREEN FUNCTIONS =====

        // Navigate to Photos/Videos Selection screen from Agent
        async function goToPhotosVideosSelection() {
            console.log('goToPhotosVideosSelection function called!');
            
            const selectedAgents = [];
            const projectName = document.getElementById('project-name-input')?.value || '';
            
            // Get agent data from form inputs
            const agentNameInput = document.getElementById('agentNameInput');
            const horizontalInputsRow = document.querySelector('#agentNameWrapper').nextElementSibling;
            const contactInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Contact number"]') : null;
            const emailInput = horizontalInputsRow ? horizontalInputsRow.querySelector('.partner-input[placeholder="Email (optional)"]') : null;
            
            if (agentNameInput && agentNameInput.value.trim()) {
                selectedAgents.push({
                    name: agentNameInput.value.trim(),
                    contact_number: contactInput ? contactInput.value.trim() : '',
                    email: emailInput ? emailInput.value.trim() : ''
                });
            }
            
            // Check for additional agents in the additional agents container
            const additionalAgents = document.querySelectorAll('.additional-agent-item');
            additionalAgents.forEach(agent => {
                const name = agent.querySelector('.agent-name')?.textContent;
                const contact = agent.querySelector('.agent-contact')?.textContent || '';
                const email = agent.querySelector('.agent-email')?.textContent || '';
                if (name) {
                    selectedAgents.push({ name, contact_number: contact, email });
                }
            });
            
            console.log('Collected agents:', selectedAgents);
            
            try {
                await saveAgents(selectedAgents, projectName);
                
                const agentScreen = document.getElementById('agent-screen');
                const photosVideosScreen = document.getElementById('photos-videos-selection-screen');
                
                console.log('Agent screen:', agentScreen);
                console.log('Photos/Videos screen:', photosVideosScreen);
                
                if (agentScreen) {
                    agentScreen.classList.add('hidden');
                    console.log('Agent screen hidden');
                }
                
                if (photosVideosScreen) {
                    photosVideosScreen.classList.remove('hidden');
                    console.log('Photos/Videos selection screen shown');
                } else {
                    console.error('Photos/Videos selection screen not found!');
                }
            } catch (error) {
                console.error('Failed to save agents:', error);
            }
        }

        // Go back to Agent screen from Photos/Videos Selection
        function goBackToAgent() {
            document.getElementById('photos-videos-selection-screen').classList.add('hidden');
            document.getElementById('agent-screen').classList.remove('hidden');
        }

        // Global variables for uploaded files
        let uploadedPhotos = [];
        let uploadedVideos = [];

        // Select upload type (photos or videos)
        function selectUploadType(type) {
            console.log('Selected upload type:', type);
            if (type === 'photos') {
                document.getElementById('photo-upload-input').click();
            } else if (type === 'videos') {
                document.getElementById('video-upload-input').click();
            }
        }


        // Handle photo upload
        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            console.log('Photo upload triggered, files:', files.length);
            
            try {
                // Upload files to backend
                await uploadMediaFiles(files);
                
                // Process files for preview
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        console.log('Processing image:', file.name, file.type);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('File read successfully:', file.name);
                            uploadedPhotos.push({
                                file: file,
                                url: e.target.result,
                                name: file.name
                            });
                            updatePhotoPreviews();
                        };
                        reader.onerror = function(e) {
                            console.error('Error reading file:', file.name, e);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        console.log('Skipping non-image file:', file.name, file.type);
                    }
                });
            } catch (error) {
                console.error('Failed to upload photos:', error);
            }
        }

        // Handle video upload
        async function handleVideoUpload(event) {
            const files = Array.from(event.target.files);
            console.log('Video upload triggered, files:', files.length);
            
            try {
                // Upload files to backend
                await uploadMediaFiles(files);
                
                // Process files for preview
                files.forEach(file => {
                    if (file.type.startsWith('video/')) {
                        console.log('Processing video:', file.name, file.type);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            console.log('Video file read successfully:', file.name);
                            uploadedVideos.push({
                                file: file,
                                url: e.target.result,
                                name: file.name
                            });
                            updateVideoPreviews();
                        };
                        reader.onerror = function(e) {
                            console.error('Error reading video file:', file.name, e);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        console.log('Skipping non-video file:', file.name, file.type);
                    }
                });
            } catch (error) {
                console.error('Failed to upload videos:', error);
            }
        }

        // Update photo previews
        function updatePhotoPreviews() {
            const uploadArea = document.getElementById('photos-upload-area');
            const previewContent = document.getElementById('photos-preview-content');
            const previewList = document.getElementById('photos-preview-list');

            console.log('Updating photo previews, count:', uploadedPhotos.length);
            console.log('Upload area:', uploadArea);
            console.log('Preview content:', previewContent);
            console.log('Preview list:', previewList);
            
            if (!uploadArea) {
                console.error('Upload area not found!');
                return;
            }
            if (!previewContent) {
                console.error('Preview content not found!');
                return;
            }
            if (!previewList) {
                console.error('Preview list not found!');
                return;
            }

            if (uploadedPhotos.length > 0) {
                console.log('Hiding upload area, showing preview content');
                console.log('Upload area before hide:', uploadArea.style.display);
                console.log('Preview content before show:', previewContent.style.display);
                uploadArea.style.display = 'none';
                previewContent.style.display = 'flex';
                console.log('Upload area after hide:', uploadArea.style.display);
                console.log('Preview content after show:', previewContent.style.display);
                
                previewList.innerHTML = '';
                uploadedPhotos.forEach((photo, index) => {
                    console.log('Creating preview for photo:', photo.name);
                    const photoElement = document.createElement('div');
                    photoElement.className = 'preview-item';
                    photoElement.innerHTML = `
                        <div class="preview-image-container">
                            <img src="${photo.url}" alt="${photo.name}" class="preview-image" onload="console.log('Photo loaded:', '${photo.name}')" onerror="console.error('Photo failed to load:', '${photo.name}')">
                            <button class="remove-btn" onclick="removePhoto(${index})">×</button>
                            <div class="preview-name">${photo.name}</div>
                        </div>
                    `;
                    previewList.appendChild(photoElement);
                });
                console.log('Photo previews updated, preview list children:', previewList.children.length);
            } else {
                console.log('No photos, showing upload area');
                uploadArea.style.display = 'flex';
                previewContent.style.display = 'none';
            }
        }

        // Update video previews
        function updateVideoPreviews() {
            const uploadArea = document.getElementById('videos-upload-area');
            const previewContent = document.getElementById('videos-preview-content');
            const previewList = document.getElementById('videos-preview-list');

            console.log('Updating video previews, count:', uploadedVideos.length);

            if (uploadedVideos.length > 0) {
                uploadArea.style.display = 'none';
                previewContent.style.display = 'flex';
                
                previewList.innerHTML = '';
                uploadedVideos.forEach((video, index) => {
                    const videoElement = document.createElement('div');
                    videoElement.className = 'preview-item';
                    videoElement.innerHTML = `
                        <div class="preview-image-container">
                            <video src="${video.url}" class="preview-image" controls onload="console.log('Video loaded:', '${video.name}')" onerror="console.error('Video failed to load:', '${video.name}')"></video>
                            <button class="remove-btn" onclick="removeVideo(${index})">×</button>
                            <div class="preview-name">${video.name}</div>
                        </div>
                    `;
                    previewList.appendChild(videoElement);
                });
                console.log('Video previews updated');
            } else {
                uploadArea.style.display = 'flex';
                previewContent.style.display = 'none';
                console.log('No videos, showing upload area');
            }
        }

        // Remove photo
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            updatePhotoPreviews();
        }

        // Remove video
        function removeVideo(index) {
            uploadedVideos.splice(index, 1);
            updateVideoPreviews();
        }

        // Add more photos
        function addMorePhotos() {
            document.getElementById('photo-upload-input').click();
        }

        // Add more videos
        function addMoreVideos() {
            document.getElementById('video-upload-input').click();
        }

        // ===== UPLOAD SCREEN FUNCTIONS =====

        // Navigate to Upload screen from Photos/Videos Selection
        function goToUploadScreen() {
            console.log('goToUploadScreen function called!');
            const photosVideosScreen = document.getElementById('photos-videos-selection-screen');
            const uploadScreen = document.getElementById('upload-screen');
            
            console.log('Photos/Videos screen:', photosVideosScreen);
            console.log('Upload screen:', uploadScreen);
            
            if (photosVideosScreen) {
                photosVideosScreen.classList.add('hidden');
                console.log('Photos/Videos selection screen hidden');
            }
            
            if (uploadScreen) {
                uploadScreen.classList.remove('hidden');
                console.log('Upload screen shown');
            } else {
                console.error('Upload screen not found!');
            }
        }

        // Go back to Photos/Videos Selection screen from Upload
        function goBackToPhotosVideosSelection() {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('photos-videos-selection-screen').classList.remove('hidden');
        }

        // Hash-based routing for returning to upload screen (from site-data-entry)
        (function handleHashRouteToUpload(){
            if (location.hash === '#upload') {
                const photos = document.getElementById('photos-videos-selection-screen');
                const upload = document.getElementById('upload-screen');
                if (photos) photos.classList.add('hidden');
                if (upload) upload.classList.remove('hidden');
                // clear hash so refreshes don't keep forcing
                history.replaceState('', document.title, window.location.pathname + window.location.search);
            }
        })();

        // Hash-based routing to open New Project Name screen directly
        (function handleHashRouteToNewProject(){
            if (location.hash === '#new-project') {
                const newProject = document.getElementById('new-project-screen');
                if (newProject) newProject.classList.remove('hidden');
                // clear hash to avoid re-trigger on refresh
                history.replaceState('', document.title, window.location.pathname + window.location.search);
                const input = document.getElementById('project-name-input');
                if (input) input.focus();
                // Hide Next button when arriving from Site Data Entry
                const nextBtn = document.querySelector('.new-project-main-content .next-button');
                if (nextBtn) nextBtn.style.display = 'none';
            }
        })();

        // Navigate to Site Data Entry page
        function goToNextScreen() {
            try {
                const plotsForSave = Array.isArray(uploadPlots) ? uploadPlots : [];
                const plotsPayload = { plots: plotsForSave.map((p, idx) => ({ number: idx + 1, ...p })) };
                localStorage.setItem('plotMarkingData', JSON.stringify(plotsPayload));
            } catch (e) {
                console.error('Failed to save plotMarkingData:', e);
            }
            window.location.href = 'site-data-entry.html';
        }

        // Save and navigate to Site Data Entry page
        function saveAndGoToNextScreen() {
            try {
                const plotsForSave = Array.isArray(uploadPlots) ? uploadPlots : [];
                const plotsPayload = { plots: plotsForSave.map((p, idx) => ({ number: idx + 1, ...p })) };
                localStorage.setItem('plotMarkingData', JSON.stringify(plotsPayload));
            } catch (e) {
                console.error('Failed to save plotMarkingData:', e);
            }
            window.location.href = 'site-data-entry.html';
        }

        // Upload screen variables
        let uploadPhotoUploaded = false;
        let uploadPlotNumber = 1;
        let uploadIsDrawing = false;
        let uploadIsErasing = false;
        let uploadIsPanning = false;
        let uploadStartX, uploadStartY;
        let uploadPlots = [];
        let uploadHistory = [];
        let uploadHistoryIndex = -1;
        let uploadCanvas, uploadCtx;
        let uploadImageContainer;
        
        // Transform variables for zoom and pan
        let uploadScale = 1;
        let uploadTranslateX = 0;
        let uploadTranslateY = 0;
        let uploadLastPanX = 0;
        let uploadLastPanY = 0;

        // Handle photo upload in upload screen
        function handleMainPhotoUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = document.getElementById('uploaded-photo');
                    img.src = e.target.result;
                    
                    // Show photo preview and hide placeholder
                    document.getElementById('upload-placeholder').style.display = 'none';
                    document.getElementById('photo-preview').style.display = 'block';
                    
                    // Show tool icons container
                    document.getElementById('tool-icons-container').style.display = 'block';
                    
                    document.getElementById('save-upload-btn').style.display = 'block';
                    
                    // Hide site layout text after upload
                    const siteLayoutText = document.querySelector('.site-layout-text');
                    if (siteLayoutText) {
                        siteLayoutText.style.display = 'none';
                    }
                    
                    // Expand container height
                    const container = document.getElementById('upload-photo-container');
                    container.classList.add('upload-container-expanded');
                    
                    const containerRect = container.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const availableHeight = viewportHeight - containerRect.top - 100;
                    const newHeight = Math.max(availableHeight, 400);
                    
                    container.style.setProperty('height', newHeight + 'px', 'important');
                    container.style.setProperty('max-height', 'none', 'important');
                    
                    // Initialize canvas and image container
                    initializeUploadCanvas();
                    
                    // Set mark mode as active by default
                    uploadIsDrawing = true;
                    uploadCanvas.style.cursor = 'crosshair';
                    document.getElementById('mark-btn').style.background = '#F28482';
                    
                    // Set a flag to keep mark mode active
                    window.uploadMarkModeActive = true;
                    
                    uploadPhotoUploaded = true;
                    window.photoUploaded = true;
                };
                
                reader.readAsDataURL(file);
            }
        }

        function initializeUploadCanvas() {
            uploadCanvas = document.getElementById('plot-canvas');
            uploadCtx = uploadCanvas.getContext('2d');
            uploadImageContainer = document.getElementById('image-container');
            
            // Set canvas size to match container
            const container = document.getElementById('upload-photo-container');
            uploadCanvas.width = container.offsetWidth;
            uploadCanvas.height = container.offsetHeight;
            
            // Add event listeners for different modes (mouse and touch)
            uploadCanvas.addEventListener('mousedown', handleUploadMouseDown);
            uploadCanvas.addEventListener('mousemove', handleUploadMouseMove);
            uploadCanvas.addEventListener('mouseup', handleUploadMouseUp);
            uploadCanvas.addEventListener('mouseout', handleUploadMouseUp);
            uploadCanvas.addEventListener('wheel', handleUploadWheel);
            
            // Touch events for mobile
            uploadCanvas.addEventListener('touchstart', handleUploadTouchStart, { passive: false });
            uploadCanvas.addEventListener('touchmove', handleUploadTouchMove, { passive: false });
            uploadCanvas.addEventListener('touchend', handleUploadTouchEnd, { passive: false });
            
            // Initialize tool buttons and zoom controls
            initializeUploadToolButtons();
            initializeUploadZoomControls();
            
            // Initialize history with empty state
            uploadHistory = [];
            uploadHistoryIndex = -1;
            saveToUploadHistory(); // Save initial empty state
        }

        function initializeUploadToolButtons() {
            document.getElementById('mark-btn').addEventListener('click', () => setUploadMode('mark'));
            document.getElementById('erase-btn').addEventListener('click', () => setUploadMode('erase'));
            document.getElementById('undo-back-btn').addEventListener('click', undoUploadBack);
        }

        function initializeUploadZoomControls() {
            document.getElementById('zoom-in-btn').addEventListener('click', () => uploadZoomIn());
            document.getElementById('zoom-out-btn').addEventListener('click', () => uploadZoomOut());
        }

        function setUploadMode(mode) {
            // Reset all tool images
            document.querySelectorAll('.tool-btn').forEach(img => {
                img.style.border = 'none';
            });
            
            uploadIsErasing = false;
            uploadIsPanning = false;
            
            if (mode === 'mark') {
                // Toggle mark mode
                window.uploadMarkModeActive = !window.uploadMarkModeActive;
                uploadIsDrawing = window.uploadMarkModeActive;
                if (uploadIsDrawing) {
                    uploadCanvas.style.cursor = 'crosshair';
                    document.getElementById('mark-btn').style.border = '3px solid #F28482';
                    document.getElementById('mark-btn').style.borderRadius = '50%';
                } else {
                    uploadCanvas.style.cursor = 'grab';
                }
            } else if (mode === 'erase') {
                uploadIsErasing = true;
                uploadIsDrawing = false;
                uploadCanvas.style.cursor = 'pointer';
                document.getElementById('erase-btn').style.border = '3px solid #F28482';
                document.getElementById('erase-btn').style.borderRadius = '50%';
            } else {
                // Default pan mode when no tool is active
                uploadIsDrawing = false;
                uploadIsErasing = false;
                uploadCanvas.style.cursor = 'grab';
            }
        }

        function handleUploadMouseDown(e) {
            e.preventDefault();
            const rect = uploadCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (uploadIsErasing) {
                // Handle erase mode - find plot at click position
                const plotToRemove = uploadPlots.find(plot => 
                    x >= plot.x && x <= plot.x + plot.width &&
                    y >= plot.y && y <= plot.y + plot.height
                );
                
                if (plotToRemove) {
                    saveToUploadHistory();
                    uploadPlots = uploadPlots.filter(plot => plot !== plotToRemove);
                    redrawUploadCanvas();
                }
                return;
            }
            
            if (window.uploadMarkModeActive) {
                // Handle mark mode - start drawing
                uploadIsDrawing = true;
                uploadStartX = x;
                uploadStartY = y;
            } else {
                // Handle pan mode - start panning when mark is inactive
                uploadIsPanning = true;
                uploadLastPanX = x;
                uploadLastPanY = y;
                uploadCanvas.style.cursor = 'grabbing';
            }
        }

        function handleUploadMouseMove(e) {
            if (uploadIsPanning) {
                // Handle pan mode
                const rect = uploadCanvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                const deltaX = currentX - uploadLastPanX;
                const deltaY = currentY - uploadLastPanY;
                
                uploadTranslateX += deltaX;
                uploadTranslateY += deltaY;
                
                uploadLastPanX = currentX;
                uploadLastPanY = currentY;
                
                updateUploadTransform();
                return;
            }
            
            if (uploadIsDrawing && uploadStartX !== null && uploadStartY !== null) {
                // Handle drawing mode
                const rect = uploadCanvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                // Clear canvas and redraw all plots
                uploadCtx.clearRect(0, 0, uploadCanvas.width, uploadCanvas.height);
                redrawUploadPlots();
                
                // Draw current rectangle being drawn - fixed on image
                uploadCtx.strokeStyle = '#F28482';
                uploadCtx.lineWidth = 2;
                uploadCtx.setLineDash([5, 5]);
                uploadCtx.strokeRect(
                    Math.min(uploadStartX, currentX),
                    Math.min(uploadStartY, currentY),
                    Math.abs(currentX - uploadStartX),
                    Math.abs(currentY - uploadStartY)
                );
            }
        }

        function handleUploadMouseUp(e) {
            if (uploadIsPanning) {
                uploadIsPanning = false;
                uploadCanvas.style.cursor = 'grab';
                return;
            }
            
            if (uploadIsDrawing) {
                const rect = uploadCanvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                
                // Only create plot if it's large enough
                const width = Math.abs(endX - uploadStartX);
                const height = Math.abs(endY - uploadStartY);
                
                if (width > 10 && height > 10) {
                    saveToUploadHistory();
                    
                    const plot = {
                        x: Math.min(uploadStartX, endX),
                        y: Math.min(uploadStartY, endY),
                        width: width,
                        height: height,
                        number: uploadPlotNumber++
                    };
                    
                    uploadPlots.push(plot);
                    redrawUploadCanvas();
                }
                
                // Reset drawing state after completing a plot
                uploadIsDrawing = false;
                uploadStartX = null;
                uploadStartY = null;
                
                // Keep mark mode ready for next drawing if it was active
                if (window.uploadMarkModeActive) {
                    uploadCanvas.style.cursor = 'crosshair';
                } else {
                    uploadCanvas.style.cursor = 'grab';
                }
            }
        }

        function handleUploadWheel(e) {
            e.preventDefault();
            
            const rect = uploadCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.max(0.5, Math.min(3, uploadScale * zoomFactor));
            
            // Zoom towards mouse position
            const scaleChange = newScale / uploadScale;
            uploadTranslateX = mouseX - (mouseX - uploadTranslateX) * scaleChange;
            uploadTranslateY = mouseY - (mouseY - uploadTranslateY) * scaleChange;
            uploadScale = newScale;
            
            updateUploadTransform();
        }

        function uploadZoomIn() {
            const rect = uploadCanvas.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const newScale = Math.min(3, uploadScale * 1.2);
            const scaleChange = newScale / uploadScale;
            
            uploadTranslateX = centerX - (centerX - uploadTranslateX) * scaleChange;
            uploadTranslateY = centerY - (centerY - uploadTranslateY) * scaleChange;
            uploadScale = newScale;
            
            updateUploadTransform();
        }

        function uploadZoomOut() {
            const rect = uploadCanvas.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const newScale = Math.max(0.5, uploadScale / 1.2);
            const scaleChange = newScale / uploadScale;
            
            uploadTranslateX = centerX - (centerX - uploadTranslateX) * scaleChange;
            uploadTranslateY = centerY - (centerY - uploadTranslateY) * scaleChange;
            uploadScale = newScale;
            
            updateUploadTransform();
        }

        function uploadResetZoom() {
            uploadScale = 1;
            uploadTranslateX = 0;
            uploadTranslateY = 0;
            updateUploadTransform();
        }

        function updateUploadTransform() {
            uploadImageContainer.style.transform = `translate(${uploadTranslateX}px, ${uploadTranslateY}px) scale(${uploadScale})`;
            redrawUploadCanvas();
        }

        function redrawUploadCanvas() {
            uploadCtx.clearRect(0, 0, uploadCanvas.width, uploadCanvas.height);
            redrawUploadPlots();
        }

        function redrawUploadPlots() {
            uploadPlots.forEach(plot => {
                // Draw rectangle - plots stay fixed on the image, not moving with pan
                uploadCtx.strokeStyle = '#F28482';
                uploadCtx.lineWidth = 2;
                uploadCtx.setLineDash([]);
                uploadCtx.strokeRect(
                    plot.x,
                    plot.y,
                    plot.width,
                    plot.height
                );
                
                // Draw number
                uploadCtx.fillStyle = '#F28482';
                uploadCtx.font = '16px Monaco';
                uploadCtx.textAlign = 'center';
                uploadCtx.fillText(
                    plot.number.toString(),
                    plot.x + plot.width / 2,
                    plot.y + plot.height / 2 + 6
                );
            });
        }

        function saveToUploadHistory() {
            // Remove any history after current index
            uploadHistory = uploadHistory.slice(0, uploadHistoryIndex + 1);
            
            // Add current state to history
            uploadHistory.push(JSON.parse(JSON.stringify(uploadPlots)));
            uploadHistoryIndex++;
            
            // Limit history size
            if (uploadHistory.length > 50) {
                uploadHistory.shift();
                uploadHistoryIndex--;
            }
        }

        function undoUploadBack() {
            if (uploadHistoryIndex > 0) {
                uploadHistoryIndex--;
                uploadPlots = JSON.parse(JSON.stringify(uploadHistory[uploadHistoryIndex]));
                redrawUploadCanvas();
            }
        }


        // Touch event handlers for mobile
        function handleUploadTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const rect = uploadCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                if (uploadIsErasing) {
                    // Handle erase mode - find plot at touch position
                    const plotToRemove = uploadPlots.find(plot => 
                        x >= plot.x && x <= plot.x + plot.width &&
                        y >= plot.y && y <= plot.y + plot.height
                    );
                    
                    if (plotToRemove) {
                        saveToUploadHistory();
                        uploadPlots = uploadPlots.filter(plot => plot !== plotToRemove);
                        redrawUploadCanvas();
                    }
                    return;
                }
                
                if (window.uploadMarkModeActive) {
                    // Handle mark mode - start drawing
                    uploadIsDrawing = true;
                    uploadStartX = x;
                    uploadStartY = y;
                } else {
                    // Handle pan mode - start panning when mark is inactive
                    uploadIsPanning = true;
                    uploadLastPanX = x;
                    uploadLastPanY = y;
                }
            } else if (e.touches.length === 2) {
                // Handle pinch zoom
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const rect = uploadCanvas.getBoundingClientRect();
                
                const centerX = (touch1.clientX + touch2.clientX) / 2 - rect.left;
                const centerY = (touch1.clientY + touch2.clientY) / 2 - rect.top;
                
                const distance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) + 
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
                
                // Store initial values for pinch zoom
                uploadCanvas.initialDistance = distance;
                uploadCanvas.initialScale = uploadScale;
                uploadCanvas.initialTranslateX = uploadTranslateX;
                uploadCanvas.initialTranslateY = uploadTranslateY;
                uploadCanvas.initialCenterX = centerX;
                uploadCanvas.initialCenterY = centerY;
            }
        }

        function handleUploadTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1 && uploadIsPanning) {
                // Handle pan mode
                const touch = e.touches[0];
                const rect = uploadCanvas.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;
                
                const deltaX = currentX - uploadLastPanX;
                const deltaY = currentY - uploadLastPanY;
                
                uploadTranslateX += deltaX;
                uploadTranslateY += deltaY;
                
                uploadLastPanX = currentX;
                uploadLastPanY = currentY;
                
                updateUploadTransform();
            } else if (e.touches.length === 1 && uploadIsDrawing && uploadStartX !== null && uploadStartY !== null) {
                // Handle drawing mode
                const touch = e.touches[0];
                const rect = uploadCanvas.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;
                
                // Clear canvas and redraw all plots
                uploadCtx.clearRect(0, 0, uploadCanvas.width, uploadCanvas.height);
                redrawUploadPlots();
                
                // Draw current rectangle being drawn
                uploadCtx.strokeStyle = '#F28482';
                uploadCtx.lineWidth = 2;
                uploadCtx.setLineDash([5, 5]);
                uploadCtx.strokeRect(
                    Math.min(uploadStartX, currentX),
                    Math.min(uploadStartY, currentY),
                    Math.abs(currentX - uploadStartX),
                    Math.abs(currentY - uploadStartY)
                );
            } else if (e.touches.length === 2) {
                // Handle pinch zoom
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const rect = uploadCanvas.getBoundingClientRect();
                
                const currentDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) + 
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
                
                if (uploadCanvas.initialDistance) {
                    const scaleChange = currentDistance / uploadCanvas.initialDistance;
                    const newScale = Math.max(0.5, Math.min(3, uploadCanvas.initialScale * scaleChange));
                    
                    // Zoom towards center of pinch
                    const centerX = (touch1.clientX + touch2.clientX) / 2 - rect.left;
                    const centerY = (touch1.clientY + touch2.clientY) / 2 - rect.top;
                    
                    uploadTranslateX = centerX - (centerX - uploadCanvas.initialTranslateX) * (newScale / uploadCanvas.initialScale);
                    uploadTranslateY = centerY - (centerY - uploadCanvas.initialTranslateY) * (newScale / uploadCanvas.initialScale);
                    uploadScale = newScale;
                    
                    updateUploadTransform();
                }
            }
        }

        function handleUploadTouchEnd(e) {
            e.preventDefault();
            if (e.touches.length === 0) {
                if (uploadIsPanning) {
                    uploadIsPanning = false;
                } else if (uploadIsDrawing) {
                    // Finish drawing
                    const touch = e.changedTouches[0];
                    const rect = uploadCanvas.getBoundingClientRect();
                    const endX = touch.clientX - rect.left;
                    const endY = touch.clientY - rect.top;
                    
                    // Only create plot if it's large enough
                    const width = Math.abs(endX - uploadStartX);
                    const height = Math.abs(endY - uploadStartY);
                    
                    if (width > 10 && height > 10) {
                        saveToUploadHistory();
                        
                        const plot = {
                            x: Math.min(uploadStartX, endX),
                            y: Math.min(uploadStartY, endY),
                            width: width,
                            height: height,
                            number: uploadPlotNumber++
                        };
                        
                        uploadPlots.push(plot);
                        redrawUploadCanvas();
                    }
                    
                    // Reset drawing state after completing a plot
                    uploadIsDrawing = false;
                    uploadStartX = null;
                    uploadStartY = null;
                    
                    // Keep mark mode ready for next drawing if it was active
                    if (window.uploadMarkModeActive) {
                        uploadCanvas.style.cursor = 'crosshair';
                    } else {
                        uploadCanvas.style.cursor = 'grab';
                    }
                }
                
                // Reset pinch zoom
                uploadCanvas.initialDistance = null;
            }
        }
        
        // Removed Select Partners modal and related functions
    </script>
</body>
</html>
